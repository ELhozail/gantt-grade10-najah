×”×œ×™×š'?'selected':''}>×‘×ª×”×œ×™×š</option>
            <option ${k.status==='×”×•×©×œ×'?'selected':''}>×”×•×©×œ×</option>
          </select>
        </td>
        <td class="actions">
          <button class="btn" onclick="openKpi('${k.id}')">âœï¸ ×¢×¨×™×›×”</button>
          <button class="btn danger" onclick="removeKpi('${k.id}')">ğŸ—‘ï¸ ××—×™×§×”</button>
        </td>
      </tr>
    `);
  });
}

/* ====== CRUD ××©×™××•×ª â€“ ××•×“××œ ====== */
byId('addTaskBtn').onclick = ()=>{
  const dlg = byId('taskDlg');
  byId('tId').value='(×—×“×©)';
  byId('tName').value='×¤×¢×™×œ×•×ª ×—×“×©×”';
  byId('tDomain').value='×œ×™××•×“×™';
  byId('tStart').value='2025-09-15';
  byId('tEnd').value='2025-09-20';
  byId('tStatus').value='×‘×ª×›× ×•×Ÿ';
  byId('tProg').value=0;
  byId('tDep').value='';
  byId('tNote').value='';
  byId('tDelete').style.visibility='hidden';
  dlg.showModal();
  byId('tSave').onclick = (e)=>{ e.preventDefault(); saveTaskForm(null); };
};

function openTask(id){
  const t = tasks.find(x=>x.id===id);
  const dlg = byId('taskDlg');
  byId('tId').value=t.id;
  byId('tName').value=t.action;
  byId('tDomain').value=t.domain;
  byId('tStart').value=t.start;
  byId('tEnd').value=t.end;
  byId('tStatus').value=t.status;
  byId('tProg').value=t.progress||0;
  byId('tDep').value=t.dependencies||'';
  byId('tNote').value=t.note||'';
  byId('tDelete').style.visibility='visible';
  dlg.showModal();
  byId('tSave').onclick = (e)=>{ e.preventDefault(); saveTaskForm(t.id); };
  byId('tDelete').onclick = ()=>{ removeTask(id); dlg.close(); };
}

function saveTaskForm(existingId){
  let start = clampToSchoolYear(byId('tStart').value);
  let end   = clampToSchoolYear(byId('tEnd').value);
  if(new Date(start)>new Date(end)){ alert('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™/×©×•×•×” ×œ×¡×™×•×'); return; }
  if(!withinSchoolYear(start)||!withinSchoolYear(end)){ alert('×©× ×ª ×”×œ×™××•×“×™×: 01.09.2025â€“31.08.2026'); return; }
  const obj = {
    id: existingId || newId(),
    domain: byId('tDomain').value,
    action: byId('tName').value.trim(),
    start, end,
    status: byId('tStatus').value,
    dependencies: byId('tDep').value.trim(),
    progress: Math.max(0,Math.min(100, Number(byId('tProg').value||0))),
    note: byId('tNote').value.trim()
  };
  if(existingId){ tasks = tasks.map(t=>t.id===existingId?obj:t); }
  else{ tasks.push(obj); }
  save(); byId('taskDlg').close(); drawAll();
}

function removeTask(id){
  if(!confirm('×œ××—×•×§ ××ª ×”×¤×¢×™×œ×•×ª?')) return;
  tasks = tasks.filter(t=>t.id!==id);
  save(); drawAll();
}
function updateTaskStatus(id,val){
  tasks = tasks.map(t=>t.id===id?{...t,status:val}:t);
  save(); drawGantt(); drawTasksTable();
}

/* ====== CRUD KPI â€“ ××•×“××œ ====== */
byId('addKpiBtn').onclick = ()=>{
  const dlg = byId('kpiDlg');
  byId('kId').value='(×—×“×©)';
  byId('kDomain').value='×œ×™××•×“×™';
  byId('kMetric').value='××“×“ ×—×“×©';
  byId('kTarget').value='×™×¢×“ ×—×“×©';
  byId('kTool').value='×›×œ×™ ××“×™×“×”';
  byId('kStatus').value='×‘×ª×›× ×•×Ÿ';
  byId('kNote').value='';
  byId('kDelete').style.visibility='hidden';
  dlg.showModal();
  byId('kSave').onclick=(e)=>{e.preventDefault(); saveKpiForm(null);};
};

function openKpi(id){
  const k = kpis.find(x=>x.id===id);
  const dlg = byId('kpiDlg');
  byId('kId').value=k.id;
  byId('kDomain').value=k.domain;
  byId('kMetric').value=k.metric;
  byId('kTarget').value=k.target;
  byId('kTool').value=k.tool;
  byId('kStatus').value=k.status;
  byId('kNote').value=k.note||'';
  byId('kDelete').style.visibility='visible';
  dlg.showModal();
  byId('kSave').onclick=(e)=>{e.preventDefault(); saveKpiForm(k.id);};
  byId('kDelete').onclick=()=>{ removeKpi(id); dlg.close(); };
}

function saveKpiForm(existingId){
  const obj = {
    id: existingId || newId(),
    domain: byId('kDomain').value,
    metric: byId('kMetric').value.trim(),
    target: byId('kTarget').value.trim(),
    tool: byId('kTool').value.trim(),
    status: byId('kStatus').value,
    note: byId('kNote').value.trim()
  };
  if(existingId){ kpis = kpis.map(k=>k.id===existingId?obj:k); }
  else{ kpis.push(obj); }
  save(); byId('kpiDlg').close(); drawKpiTable();
}

function removeKpi(id){
  if(!confirm('×œ××—×•×§ ××ª ×”-KPI?')) return;
  kpis = kpis.filter(k=>k.id!==id);
  save(); drawKpiTable();
}
function updateKpiStatus(id,val){
  kpis = kpis.map(k=>k.id===id?{...k,status:val}:k);
  save();
}

/* ====== ×”×“×¤×¡×” ====== */
byId('printBtn').onclick = ()=>{
  const incG = byId('printGantt').checked;
  const incT = byId('printTasks').checked;
  const incK = byId('printKpi').checked;
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>×”×“×¤×¡×”</title>
  <style>body{font-family:Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px;text-align:center} th{background:#eee}</style></head><body>`;
  if(incG) html += byId('ganttWrap').outerHTML;
  if(incT) html += byId('taskTable').outerHTML;
  if(incK) html += byId('kpiTable').outerHTML;
  html+='</body></html>';
  const w=window.open('','print');
  w.document.write(html); w.document.close(); w.focus(); w.print(); w.close();
};

/* ====== ×™×™×¦×•×/×™×™×‘×•×/××™×¤×•×¡ ====== */
byId('exportXlsxBtn').onclick = ()=>{
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tasks), '××©×™××•×ª');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kpis),  'KPI');
  XLSX.writeFile(wb, 'school_plan.xlsx');
};
byId('exportJsonBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify({tasks,kpis},null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='school_plan.json'; a.click();
};
byId('importJson').onchange = (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const fr = new FileReader();
  fr.onload = () =>{
    try{
      const obj = JSON.parse(fr.result);
      if(Array.isArray(obj.tasks)&&Array.isArray(obj.kpis)){
        tasks=obj.tasks; kpis=obj.kpis; save(); drawAll();
      }else alert('×§×•×‘×¥ JSON ×œ× ×ª×§×™×Ÿ');
    }catch(err){ alert('×©×’×™××” ×‘×§×¨×™××ª JSON'); }
  };
  fr.readAsText(file);
};
byId('resetBtn').onclick = ()=>{
  if(!confirm('×œ××¤×¡ ×œ× ×ª×•× ×™ ×‘×¨×™×¨×ª ××—×“×œ?')) return;
  tasks = structuredClone(defaultTasks);
  kpis  = structuredClone(defaultKpis);
  save(); drawAll();
};

/* ====== ×ª×¦×•×’×” â€“ ×™×•×/×©×‘×•×¢/×—×•×“×© ====== */
byId('viewDay').onclick  = ()=>{ currentView='Day';  drawGantt(); };
byId('viewWeek').onclick = ()=>{ currentView='Week'; drawGantt(); };
byId('viewMonth').onclick= ()=>{ currentView='Month';drawGantt(); };

/* ====== ×¨×¢× ×•×Ÿ ×›×•×œ×œ ====== */
function drawAll(){
  drawGantt();
  drawTasksTable();
  drawKpiTable();
}

/* ×˜×¢×™× ×” ×¨××©×•× ×™×ª */
renderChips();
google.charts.setOnLoadCallback(drawAll);
</script>
</body>
</html>
